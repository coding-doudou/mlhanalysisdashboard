from IPython.display import display, HTML
from pyspark.sql.window import Window
from pyspark.sql.functions import *
import base64
import json

# =============================================================================
# LOAD 2025 DATA
# =============================================================================
df_2025 = spark.sql("SELECT * FROM MLH_LH.dbo.`MLH ANALYSIS` WHERE Year = 2025")

# =============================================================================
# Q4 2025 DATA (October, November, December) - EXCLUDE 2026 WEEKS
# =============================================================================

df_q4 = df_2025.filter(col("Month").isin([10, 11, 12]))
df_q4 = df_q4.withColumn("Week_Num", weekofyear(col("MAWBDate")))
df_q4 = df_q4.withColumn("Week_Start", date_trunc("week", col("MAWBDate")))

# Filter out Week 1 (which belongs to 2026) - keep only weeks 40-52
df_q4 = df_q4.filter((col("Week_Num") >= 40) & (col("Week_Num") <= 52))

# =============================================================================
# OVERALL Q4 METRICS
# =============================================================================
total_spend_q4 = df_q4.agg(sum("TotalCost")).collect()[0][0]
total_waybills_q4 = df_q4.count()
total_miles_q4 = df_q4.agg(sum("Distance")).collect()[0][0]

# =============================================================================
# LANE-LEVEL VENDOR ANALYSIS
# =============================================================================

lane_vendor_q4 = df_q4.groupBy("Week_Num", "OD Pair", "Carrier Category", "CARRIER_NAME").agg(
    count("Waybill").alias("Waybills"),
    bround(sum("TotalCost"), 0).alias("Total_Spend"),
    bround(sum("Distance"), 0).alias("Total_Miles")
).withColumn("CPM", bround(col("Total_Spend") / col("Total_Miles"), 2))

w = Window.partitionBy("Week_Num", "OD Pair", "Carrier Category")

lane_analysis_q4 = lane_vendor_q4.withColumn(
    "Best_CPM", min("CPM").over(w)
).withColumn(
    "Best_Vendor", first("CARRIER_NAME").over(w.orderBy("CPM"))
).withColumn(
    "Vendor_Count", count("CARRIER_NAME").over(w)
).withColumn(
    "Rank", row_number().over(w.orderBy("CPM"))
).withColumn(
    "CPM_Premium", bround(col("CPM") - col("Best_CPM"), 2)
).withColumn(
    "Potential_Savings", bround(col("CPM_Premium") * col("Total_Miles"), 0)
)

# Get all data for interactive use
all_data = lane_analysis_q4.select(
    "Week_Num", "OD Pair", "Carrier Category", "CARRIER_NAME", 
    "Waybills", "Total_Spend", "Total_Miles", "CPM", 
    "Best_CPM", "Best_Vendor", "Vendor_Count", "Rank", "CPM_Premium", "Potential_Savings"
).orderBy("Week_Num", "Carrier Category", "OD Pair", "CPM").toPandas()

# Filter for savings opportunities
savings_data = all_data[(all_data["Vendor_Count"] > 1) & (all_data["CPM_Premium"] > 0)].copy()

# Get unique values for filters
weeks = sorted(all_data["Week_Num"].unique().tolist())
categories = sorted(all_data["Carrier Category"].dropna().unique().tolist())
lanes = sorted(all_data["OD Pair"].dropna().unique().tolist())
vendors = sorted(all_data["CARRIER_NAME"].dropna().unique().tolist())

# Calculate summaries
total_savings_q4 = savings_data["Potential_Savings"].sum()
savings_pct_q4 = (total_savings_q4 / total_spend_q4) * 100 if total_spend_q4 else 0

# Prepare JSON data for JavaScript
all_data_json = all_data.to_json(orient='records')
savings_data_json = savings_data.to_json(orient='records')

# Create week labels (Week 40 = Oct Week 1, etc.)
def get_week_label(week_num):
    if week_num >= 40 and week_num <= 43:
        return f"Oct W{week_num - 39}"
    elif week_num >= 44 and week_num <= 47:
        return f"Nov W{week_num - 43}"
    elif week_num >= 48 and week_num <= 52:
        return f"Dec W{week_num - 47}"
    else:
        return f"W{week_num}"

week_labels = {w: get_week_label(w) for w in weeks}
week_labels_json = json.dumps(week_labels)

# =============================================================================
# STYLING
# =============================================================================
MAERSK_NAVY = "#00243D"
MAERSK_BLUE = "#42B0D5"
MAERSK_TEAL = "#0A7A8F"
SUCCESS = "#28a745"
WARNING = "#e6a000"
DANGER = "#dc3545"

# =============================================================================
# BUILD INTERACTIVE DASHBOARD
# =============================================================================

interactive_dashboard = f"""
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MLH Carrier Optimization - Q4 2025 Interactive Planning Tool</title>
    <style>
        * {{ margin: 0; padding: 0; box-sizing: border-box; }}
        body {{ font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Arial, sans-serif; background: #f5f7fa; }}
        
        /* HEADER */
        .header {{ background: {MAERSK_NAVY}; color: white; padding: 20px 30px; position: sticky; top: 0; z-index: 100; }}
        .header-content {{ display: flex; justify-content: space-between; align-items: center; }}
        .header h1 {{ font-size: 22px; font-weight: 400; letter-spacing: 1px; }}
        .header-stats {{ display: flex; gap: 40px; }}
        .header-stat {{ text-align: center; }}
        .header-stat-value {{ font-size: 24px; font-weight: 700; }}
        .header-stat-value.highlight {{ color: {SUCCESS}; }}
        .header-stat-label {{ font-size: 11px; opacity: 0.7; text-transform: uppercase; }}
        
        /* MAIN CONTAINER */
        .container {{ padding: 0; }}
        
        /* FILTER BAR */
        .filter-bar {{ background: white; border-radius: 0; padding: 20px 40px; margin-bottom: 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }}
        .filter-row {{ display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; }}
        .filter-group {{ flex: 1; min-width: 150px; }}
        .filter-group label {{ display: block; font-size: 11px; font-weight: 600; color: #666; text-transform: uppercase; margin-bottom: 5px; }}
        .filter-group select, .filter-group input {{ width: 100%; padding: 12px 14px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }}
        .filter-group select:focus, .filter-group input:focus {{ outline: none; border-color: {MAERSK_BLUE}; box-shadow: 0 0 0 2px rgba(66,176,213,0.2); }}
        .filter-group select {{ cursor: pointer; background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E") no-repeat right 10px center; appearance: none; padding-right: 30px; }}
        .btn {{ padding: 12px 24px; border: none; border-radius: 4px; font-size: 13px; cursor: pointer; font-weight: 600; transition: all 0.2s; }}
        .btn-primary {{ background: {MAERSK_NAVY}; color: white; }}
        .btn-secondary {{ background: #e9ecef; color: #333; }}
        .btn-success {{ background: {SUCCESS}; color: white; }}
        .btn:hover {{ opacity: 0.9; }}
        
        /* MONTH FILTER BUTTONS */
        .month-filters {{ display: flex; gap: 10px; margin-bottom: 15px; }}
        .month-btn {{ padding: 10px 24px; border: 2px solid {MAERSK_NAVY}; background: white; color: {MAERSK_NAVY}; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s; }}
        .month-btn.active {{ background: {MAERSK_NAVY}; color: white; }}
        .month-btn:hover {{ background: {MAERSK_BLUE}; border-color: {MAERSK_BLUE}; color: white; }}
        
        /* TABS */
        .tabs {{ display: flex; gap: 8px; margin-bottom: 0; padding: 20px 40px; background: #f5f7fa; }}
        .tab {{ padding: 14px 28px; background: white; border: none; border-radius: 4px 4px 0 0; cursor: pointer; font-size: 14px; font-weight: 600; color: #666; transition: all 0.2s; }}
        .tab:hover {{ background: #e9ecef; }}
        .tab.active {{ background: {MAERSK_NAVY}; color: white; }}
        .tab-content {{ display: none; }}
        .tab-content.active {{ display: block; padding: 25px 40px; background: #f5f7fa; }}
        
        /* CARDS */
        .card {{ background: white; border-radius: 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 0; overflow: hidden; }}
        .card-header {{ background: {MAERSK_NAVY}; color: white; padding: 18px 25px; font-size: 15px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }}
        .card-body {{ padding: 25px; }}
        
        /* GRID */
        .grid-2 {{ display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }}
        .grid-3 {{ display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 25px; }}
        .grid-4 {{ display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }}
        
        /* KPI CARDS */
        .kpi-card {{ background: white; border-radius: 4px; padding: 25px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }}
        .kpi-value {{ font-size: 32px; font-weight: 700; color: {MAERSK_NAVY}; }}
        .kpi-value.success {{ color: {SUCCESS}; }}
        .kpi-value.warning {{ color: {WARNING}; }}
        .kpi-value.danger {{ color: {DANGER}; }}
        .kpi-label {{ font-size: 11px; color: #666; text-transform: uppercase; margin-top: 5px; }}
        .kpi-change {{ font-size: 12px; margin-top: 8px; padding: 3px 8px; border-radius: 3px; display: inline-block; }}
        .kpi-change.up {{ background: #e8f5e9; color: {SUCCESS}; }}
        .kpi-change.down {{ background: #fde8e8; color: {DANGER}; }}
        
        /* TABLE */
        .data-table {{ width: 100%; border-collapse: collapse; font-size: 12px; }}
        .data-table th {{ background: #f8f9fa; padding: 12px 10px; text-align: left; font-size: 10px; text-transform: uppercase; color: #666; border-bottom: 2px solid #eee; position: sticky; top: 0; }}
        .data-table th.sortable {{ cursor: pointer; }}
        .data-table th.sortable:hover {{ background: #e9ecef; }}
        .data-table th .sort-icon {{ margin-left: 5px; opacity: 0.3; }}
        .data-table th.sorted .sort-icon {{ opacity: 1; }}
        .data-table td {{ padding: 10px; border-bottom: 1px solid #f0f0f0; }}
        .data-table tr:hover {{ background: #f8f9fa; }}
        .data-table tr.selected {{ background: #e3f2fd !important; }}
        .data-table .number {{ text-align: right; font-family: 'Consolas', monospace; }}
        .data-table .savings {{ color: {SUCCESS}; font-weight: 600; }}
        .data-table .premium {{ color: {DANGER}; }}
        .table-container {{ max-height: 600px; overflow-y: auto; }}
        
        /* CHECKBOX */
        .checkbox-cell {{ width: 40px; text-align: center; }}
        .checkbox-cell input {{ width: 16px; height: 16px; cursor: pointer; }}
        
        /* PLANNING PANEL */
        .planning-panel {{ background: white; border-radius: 0; padding: 15px 40px; margin-bottom: 0; border-bottom: 1px solid #e9ecef; }}
        .planning-header {{ display: flex; justify-content: space-between; align-items: center; }}
        .planning-title {{ font-size: 13px; font-weight: 600; color: {MAERSK_NAVY}; display: flex; align-items: center; gap: 8px; }}
        .planning-title-icon {{ width: 8px; height: 8px; background: {SUCCESS}; border-radius: 50%; }}
        .planning-grid {{ display: flex; gap: 40px; align-items: center; }}
        .planning-stat {{ text-align: center; white-space: nowrap; padding: 0 15px; border-left: 1px solid #e9ecef; }}
        .planning-stat:first-child {{ border-left: none; }}
        .planning-stat-value {{ font-size: 20px; font-weight: 700; color: {MAERSK_NAVY}; }}
        .planning-stat-value.highlight {{ color: {SUCCESS}; }}
        .planning-stat-label {{ font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }}
        
        /* SCENARIO BUILDER */
        .scenario-item {{ background: #f8f9fa; border-radius: 4px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }}
        .scenario-info {{ flex: 1; }}
        .scenario-lane {{ font-weight: 600; color: {MAERSK_NAVY}; }}
        .scenario-detail {{ font-size: 12px; color: #666; margin-top: 3px; }}
        .scenario-savings {{ font-size: 18px; font-weight: 700; color: {SUCCESS}; }}
        .scenario-remove {{ background: none; border: none; color: {DANGER}; cursor: pointer; font-size: 18px; margin-left: 15px; }}
        
        /* PROGRESS */
        .progress-bar {{ height: 8px; background: #e9ecef; border-radius: 2px; overflow: hidden; }}
        .progress-fill {{ height: 100%; border-radius: 2px; transition: width 0.3s; }}
        .progress-fill.success {{ background: {SUCCESS}; }}
        .progress-fill.warning {{ background: {WARNING}; }}
        .progress-fill.danger {{ background: {DANGER}; }}
        
        /* VENDOR COMPARISON */
        .vendor-compare {{ display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: center; }}
        .vendor-box {{ background: #f8f9fa; border-radius: 4px; padding: 20px; text-align: center; }}
        .vendor-box.current {{ border: 2px solid {DANGER}; }}
        .vendor-box.recommended {{ border: 2px solid {SUCCESS}; }}
        .vendor-name {{ font-weight: 600; font-size: 14px; color: {MAERSK_NAVY}; margin-bottom: 10px; }}
        .vendor-cpm {{ font-size: 28px; font-weight: 700; }}
        .vendor-cpm.high {{ color: {DANGER}; }}
        .vendor-cpm.low {{ color: {SUCCESS}; }}
        .vs-circle {{ width: 50px; height: 50px; background: {MAERSK_NAVY}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; }}
        
        /* ALERTS */
        .alert {{ padding: 15px 20px; border-radius: 4px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }}
        .alert-success {{ background: #e8f5e9; color: {SUCCESS}; }}
        .alert-warning {{ background: #fff3cd; color: {WARNING}; }}
        .alert-info {{ background: #e3f2fd; color: {MAERSK_BLUE}; }}
        
        /* EXPORT PANEL */
        .export-panel {{ background: #f8f9fa; border-radius: 4px; padding: 20px; margin-top: 20px; }}
        .export-title {{ font-weight: 600; margin-bottom: 15px; }}
        .export-buttons {{ display: flex; gap: 10px; flex-wrap: wrap; }}
        
        /* RESPONSIVE */
        @media (max-width: 1200px) {{
            .grid-4 {{ grid-template-columns: repeat(2, 1fr); }}
            .planning-grid {{ grid-template-columns: repeat(2, 1fr); }}
        }}
        @media (max-width: 768px) {{
            .grid-2, .grid-3 {{ grid-template-columns: 1fr; }}
            .filter-row {{ flex-direction: column; }}
        }}
    </style>
</head>
<body>

    <!-- HEADER -->
    <div class="header">
        <div class="header-content">
            <div>
                <h1>MLH CARRIER OPTIMIZATION</h1>
                <div style="font-size: 12px; opacity: 0.7;">Interactive Planning Tool | Q4 2025 (Oct - Dec)</div>
            </div>
            <div class="header-stats">
                <div class="header-stat">
                    <div class="header-stat-value">${total_spend_q4/1000000:.2f}M</div>
                    <div class="header-stat-label">Q4 Total Spend</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-value highlight" id="headerSavings">${total_savings_q4/1000:.0f}K</div>
                    <div class="header-stat-label">Potential Savings</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-value">{total_waybills_q4:,}</div>
                    <div class="header-stat-label">Waybills</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-value">{len(weeks)}</div>
                    <div class="header-stat-label">Weeks</div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        
        <!-- PLANNING PANEL -->
        <div class="planning-panel">
            <div class="planning-header">
                <div class="planning-title"><span class="planning-title-icon"></span> Filtered Results</div>
                <div class="planning-grid">
                    <div class="planning-stat">
                        <div class="planning-stat-value" id="planLanes">0</div>
                        <div class="planning-stat-label">Lanes</div>
                    </div>
                    <div class="planning-stat">
                        <div class="planning-stat-value" id="planWaybills">0</div>
                        <div class="planning-stat-label">Waybills</div>
                    </div>
                    <div class="planning-stat">
                        <div class="planning-stat-value highlight" id="planSavings">$0</div>
                        <div class="planning-stat-label">Potential Savings</div>
                    </div>
                    <div class="planning-stat">
                        <div class="planning-stat-value" id="planPct">0%</div>
                        <div class="planning-stat-label">of Total</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FILTER BAR -->
        <div class="filter-bar">
            <!-- ACTIVE FILTERS DISPLAY -->
            <div id="activeFilters" style="display: none; margin-bottom: 15px; padding: 10px 15px; background: #e3f2fd; border-radius: 6px; font-size: 12px;">
                <span style="font-weight: 600; color: #00243D;">Active Filters:</span>
                <span id="activeFiltersList"></span>
                <button onclick="resetFilters()" style="margin-left: 10px; background: none; border: none; color: #dc3545; cursor: pointer; font-size: 12px;">‚úï Clear All</button>
            </div>
            
            <!-- MONTH QUICK FILTERS -->
            <div class="month-filters">
                <button class="month-btn active" onclick="filterByMonth('all')">All Q4</button>
                <button class="month-btn" onclick="filterByMonth('oct')">October</button>
                <button class="month-btn" onclick="filterByMonth('nov')">November</button>
                <button class="month-btn" onclick="filterByMonth('dec')">December</button>
            </div>
            
            <div class="filter-row">
                <div class="filter-group">
                    <label>Week</label>
                    <select id="filterWeek" onchange="applyFilters()">
                        <option value="">All Weeks</option>
                        {"".join([f'<option value="{w}">{get_week_label(w)} (W{w})</option>' for w in weeks])}
                    </select>
                </div>
                <div class="filter-group">
                    <label>Carrier Category</label>
                    <select id="filterCategory" onchange="applyFilters()">
                        <option value="">All Categories</option>
                        {"".join([f'<option value="{c}">{c}</option>' for c in categories])}
                    </select>
                </div>
                <div class="filter-group">
                    <label>Lane (O-D)</label>
                    <select id="filterLane" onchange="applyFilters()">
                        <option value="">All Lanes</option>
                        {"".join([f'<option value="{l}">{l}</option>' for l in lanes])}
                    </select>
                </div>
                <div class="filter-group">
                    <label>Vendor</label>
                    <select id="filterVendor" onchange="applyFilters()">
                        <option value="">All Vendors</option>
                        {"".join([f'<option value="{v}">{v[:40]}</option>' for v in vendors])}
                    </select>
                </div>
                <div class="filter-group">
                    <label>Min Savings ($)</label>
                    <input type="number" id="filterMinSavings" placeholder="0" onchange="applyFilters()">
                </div>
                <div class="filter-group" style="flex: 0;">
                    <label>&nbsp;</label>
                    <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
                </div>
                <div class="filter-group" style="flex: 0;">
                    <label>&nbsp;</label>
                    <button class="btn btn-success" onclick="selectAllVisible()">Select All Visible</button>
                </div>
            </div>
        </div>

        <!-- TABS -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('overview')">üìä Overview</button>
            <button class="tab" onclick="showTab('lanes')">üõ§Ô∏è Lane Analysis</button>
            <button class="tab" onclick="showTab('vendors')">üöö Vendor Compare</button>
            <button class="tab" onclick="showTab('weekly')">üìÖ Weekly Trends</button>
            <button class="tab" onclick="showTab('monthly')">üìÜ Monthly Summary</button>
            <button class="tab" onclick="showTab('plan')">üìã My Plan</button>
        </div>

        <!-- OVERVIEW TAB -->
        <div id="tab-overview" class="tab-content active">
            
            <!-- KPI CARDS -->
            <div class="grid-4" style="margin-bottom: 20px;">
                <div class="kpi-card">
                    <div class="kpi-value" id="kpiTotalSavings">${total_savings_q4/1000:.0f}K</div>
                    <div class="kpi-label">Total Savings Opportunity</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpiLanes">{savings_data["OD Pair"].nunique()}</div>
                    <div class="kpi-label">Lanes with Savings</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpiAvgCPMPremium">${savings_data["CPM_Premium"].mean():.2f}</div>
                    <div class="kpi-label">Avg CPM Premium</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value success" id="kpiSavingsPct">{savings_pct_q4:.1f}%</div>
                    <div class="kpi-label">of Total Spend</div>
                </div>
            </div>
            
            <div class="grid-2">
                <!-- SAVINGS BY CATEGORY -->
                <div class="card">
                    <div class="card-header">
                        Savings by Category
                        <span id="catCount"></span>
                    </div>
                    <div class="card-body">
                        <div id="categoryChart"></div>
                    </div>
                </div>
                
                <!-- TOP LANES -->
                <div class="card">
                    <div class="card-header">
                        Top 10 Savings Opportunities
                    </div>
                    <div class="card-body">
                        <div id="topLanesChart"></div>
                    </div>
                </div>
            </div>
            
            <!-- QUICK ACTIONS -->
            <div class="card">
                <div class="card-header">Quick Actions</div>
                <div class="card-body">
                    <div class="grid-3">
                        <button class="btn btn-primary" onclick="selectTopN(10)" style="padding: 20px;">
                            <div style="font-size: 24px;">üéØ</div>
                            <div style="margin-top: 10px;">Select Top 10 Lanes</div>
                            <div style="font-size: 12px; opacity: 0.7;">Highest savings potential</div>
                        </button>
                        <button class="btn btn-primary" onclick="selectByCategory('Subhauler')" style="padding: 20px;">
                            <div style="font-size: 24px;">üöõ</div>
                            <div style="margin-top: 10px;">Focus on Subhaulers</div>
                            <div style="font-size: 12px; opacity: 0.7;">Largest category opportunity</div>
                        </button>
                        <button class="btn btn-primary" onclick="selectHighCPM()" style="padding: 20px;">
                            <div style="font-size: 24px;">üí∞</div>
                            <div style="margin-top: 10px;">High CPM Premium</div>
                            <div style="font-size: 12px; opacity: 0.7;">CPM > $0.50 over best</div>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- LANES TAB -->
        <div id="tab-lanes" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span>Lane-Level Savings Analysis</span>
                    <span id="laneCount">0 lanes</span>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="data-table" id="lanesTable">
                            <thead>
                                <tr>
                                    <th class="checkbox-cell"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                    <th class="sortable" onclick="sortTable('Week_Num')">Week <span class="sort-icon">‚Üï</span></th>
                                    <th class="sortable" onclick="sortTable('Carrier Category')">Category <span class="sort-icon">‚Üï</span></th>
                                    <th class="sortable" onclick="sortTable('OD Pair')">Lane <span class="sort-icon">‚Üï</span></th>
                                    <th class="sortable" onclick="sortTable('CARRIER_NAME')">Current Vendor <span class="sort-icon">‚Üï</span></th>
                                    <th class="sortable" onclick="sortTable('CPM')" style="text-align:right;">CPM <span class="sort-icon">‚Üï</span></th>
                                    <th class="sortable" onclick="sortTable('Best_Vendor')">Best Vendor <span class="sort-icon">‚Üï</span></th>
                                    <th class="sortable" onclick="sortTable('Best_CPM')" style="text-align:right;">Best CPM <span class="sort-icon">‚Üï</span></th>
                                    <th class="sortable" onclick="sortTable('CPM_Premium')" style="text-align:right;">Premium <span class="sort-icon">‚Üï</span></th>
                                    <th class="sortable" onclick="sortTable('Waybills')" style="text-align:right;">Waybills <span class="sort-icon">‚Üï</span></th>
                                    <th class="sortable sorted" onclick="sortTable('Potential_Savings')" style="text-align:right;">Savings <span class="sort-icon">‚Üì</span></th>
                                </tr>
                            </thead>
                            <tbody id="lanesTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- VENDORS TAB -->
        <div id="tab-vendors" class="tab-content">
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">Vendors to Reduce (Higher Cost)</div>
                    <div class="card-body">
                        <div id="reduceVendorsList"></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">Vendors to Increase (Lower Cost)</div>
                    <div class="card-body">
                        <div id="increaseVendorsList"></div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">Vendor Performance Comparison</div>
                <div class="card-body">
                    <div class="filter-row" style="margin-bottom: 20px;">
                        <div class="filter-group">
                            <label>Select Lane to Compare</label>
                            <select id="compareLane" onchange="updateVendorComparison()">
                                <option value="">Select a lane...</option>
                            </select>
                        </div>
                    </div>
                    <div id="vendorComparison"></div>
                </div>
            </div>
        </div>

        <!-- WEEKLY TAB -->
        <div id="tab-weekly" class="tab-content">
            <div class="card">
                <div class="card-header">Weekly Savings Trend (Q4 2025)</div>
                <div class="card-body">
                    <div id="weeklyTrendChart" style="height: 300px;"></div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">Weekly Savings by Category</div>
                <div class="card-body" style="overflow-x: auto;">
                    <table class="data-table" id="weeklyCategoryTable">
                        <thead>
                            <tr>
                                <th style="position: sticky; left: 0; background: #f8f9fa; z-index: 1;">Category</th>
                                {"".join([f'<th class="number">{get_week_label(w)}</th>' for w in weeks])}
                                <th class="number" style="background: {SUCCESS}; color: white;">Total</th>
                            </tr>
                        </thead>
                        <tbody id="weeklyCategoryBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- MONTHLY TAB -->
        <div id="tab-monthly" class="tab-content">
            <div class="card">
                <div class="card-header">Monthly Summary Comparison</div>
                <div class="card-body">
                    <div id="monthlyChart" style="height: 300px;"></div>
                </div>
            </div>
            
            <div class="grid-3">
                <div class="card">
                    <div class="card-header" style="background: #ff6b35;">October 2025</div>
                    <div class="card-body" id="octSummary"></div>
                </div>
                <div class="card">
                    <div class="card-header" style="background: #f7931e;">November 2025</div>
                    <div class="card-body" id="novSummary"></div>
                </div>
                <div class="card">
                    <div class="card-header" style="background: #00a651;">December 2025</div>
                    <div class="card-body" id="decSummary"></div>
                </div>
            </div>
        </div>

        <!-- MY PLAN TAB -->
        <div id="tab-plan" class="tab-content">
            <div class="alert alert-info">
                <span>üí°</span>
                <span>Select lanes from the Lane Analysis tab or use Quick Actions to build your optimization plan.</span>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span>Selected Optimization Actions</span>
                    <button class="btn btn-secondary" onclick="clearPlan()" style="padding: 5px 15px; font-size: 12px;">Clear All</button>
                </div>
                <div class="card-body">
                    <div id="planItems">
                        <div style="text-align: center; color: #999; padding: 40px;">
                            No lanes selected yet. Go to Lane Analysis to select optimization opportunities.
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="export-panel">
                <div class="export-title">Export Your Plan</div>
                <div class="export-buttons">
                    <button class="btn btn-primary" onclick="exportPlanCSV()">üì• Export as CSV</button>
                    <button class="btn btn-primary" onclick="exportPlanPDF()">üìÑ Export as PDF Report</button>
                    <button class="btn btn-success" onclick="generateActionReport()">üìä Generate Action Report</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // =============================================================================
        // DATA
        // =============================================================================
        const allData = {all_data_json};
        const savingsData = {savings_data_json};
        const weeks = {json.dumps(weeks)};
        const categories = {json.dumps(categories)};
        const weekLabels = {week_labels_json};
        const totalSavings = {total_savings_q4};
        
        // Week to month mapping
        const weekToMonth = {{}};
        weeks.forEach(w => {{
            if (w >= 40 && w <= 43) weekToMonth[w] = 'oct';
            else if (w >= 44 && w <= 47) weekToMonth[w] = 'nov';
            else if (w >= 48 && w <= 52) weekToMonth[w] = 'dec';
        }});
        
        let filteredData = [...savingsData];
        let selectedItems = new Set();
        let sortColumn = 'Potential_Savings';
        let sortDirection = 'desc';
        let activeMonth = 'all';
        
        // =============================================================================
        // INITIALIZATION
        // =============================================================================
        document.addEventListener('DOMContentLoaded', function() {{
            renderAll();
        }});
        
        function renderAll() {{
            applyFilters();
            renderCategoryChart();
            renderTopLanesChart();
            renderVendorLists();
            renderWeeklyTrend();
            renderWeeklyCategoryTable();
            renderMonthlyCharts();
            populateLaneDropdown();
        }}
        
        // =============================================================================
        // TABS
        // =============================================================================
        function showTab(tabId) {{
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelector(`[onclick="showTab('${{tabId}}')"]`).classList.add('active');
            document.getElementById(`tab-${{tabId}}`).classList.add('active');
        }}
        
        // =============================================================================
        // MONTH FILTER
        // =============================================================================
        function filterByMonth(month) {{
            activeMonth = month;
            document.querySelectorAll('.month-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`[onclick="filterByMonth('${{month}}')"]`).classList.add('active');
            document.getElementById('filterWeek').value = '';
            applyFilters();
        }}
        
        // =============================================================================
        // FILTERS
        // =============================================================================
        function applyFilters() {{
            const week = document.getElementById('filterWeek').value;
            const category = document.getElementById('filterCategory').value;
            const lane = document.getElementById('filterLane').value;
            const vendor = document.getElementById('filterVendor').value;
            const minSavings = parseFloat(document.getElementById('filterMinSavings').value) || 0;
            
            filteredData = savingsData.filter(row => {{
                // Month filter
                if (activeMonth !== 'all') {{
                    const rowMonth = weekToMonth[row.Week_Num];
                    if (rowMonth !== activeMonth) return false;
                }}
                
                if (week && row.Week_Num != week) return false;
                if (category && row['Carrier Category'] !== category) return false;
                if (lane && row['OD Pair'] !== lane) return false;
                if (vendor && row.CARRIER_NAME !== vendor) return false;
                if (row.Potential_Savings < minSavings) return false;
                return true;
            }});
            
            sortData();
            renderLanesTable();
            updateKPIs();
            updatePlanStats();
            updateFilterDropdowns();
            renderCategoryChart();
            renderTopLanesChart();
            renderVendorLists();
            renderWeeklyTrend();
            renderWeeklyCategoryTable();
            renderMonthlyCharts();
        }}
        
        function resetFilters() {{
            document.getElementById('filterWeek').value = '';
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterLane').value = '';
            document.getElementById('filterVendor').value = '';
            document.getElementById('filterMinSavings').value = '';
            activeMonth = 'all';
            document.querySelectorAll('.month-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.month-btn[onclick*="all"]').classList.add('active');
            applyFilters();
        }}
        
        function updateFilterDropdowns() {{
            // Don't dynamically update dropdowns - keep all options available
            // This prevents categories/lanes from disappearing when they have no savings opportunities
        }}
        
        // =============================================================================
        // SORTING
        // =============================================================================
        function sortTable(column) {{
            if (sortColumn === column) {{
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            }} else {{
                sortColumn = column;
                sortDirection = 'desc';
            }}
            sortData();
            renderLanesTable();
        }}
        
        function sortData() {{
            filteredData.sort((a, b) => {{
                let aVal = a[sortColumn];
                let bVal = b[sortColumn];
                if (typeof aVal === 'string') {{
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }}
                if (sortDirection === 'asc') {{
                    return aVal > bVal ? 1 : -1;
                }} else {{
                    return aVal < bVal ? 1 : -1;
                }}
            }});
        }}
        
        // =============================================================================
        // LANES TABLE
        // =============================================================================
        function renderLanesTable() {{
            const tbody = document.getElementById('lanesTableBody');
            tbody.innerHTML = filteredData.map((row, idx) => {{
                const key = `${{row.Week_Num}}-${{row['OD Pair']}}-${{row['Carrier Category']}}-${{row.CARRIER_NAME}}`;
                const isSelected = selectedItems.has(key);
                return `
                    <tr class="${{isSelected ? 'selected' : ''}}" data-key="${{key}}">
                        <td class="checkbox-cell">
                            <input type="checkbox" ${{isSelected ? 'checked' : ''}} onchange="toggleSelection('${{key}}', this.checked)">
                        </td>
                        <td>${{weekLabels[row.Week_Num] || 'W' + row.Week_Num}}</td>
                        <td>${{row['Carrier Category']}}</td>
                        <td><strong>${{row['OD Pair']}}</strong></td>
                        <td>${{row.CARRIER_NAME ? row.CARRIER_NAME.substring(0, 25) : ''}}</td>
                        <td class="number premium">$${{row.CPM.toFixed(2)}}</td>
                        <td style="color: #28a745;">${{row.Best_Vendor ? row.Best_Vendor.substring(0, 25) : ''}}</td>
                        <td class="number savings">$${{row.Best_CPM.toFixed(2)}}</td>
                        <td class="number premium">$${{row.CPM_Premium.toFixed(2)}}</td>
                        <td class="number">${{row.Waybills.toLocaleString()}}</td>
                        <td class="number savings">$${{row.Potential_Savings.toLocaleString()}}</td>
                    </tr>
                `;
            }}).join('');
            
            document.getElementById('laneCount').textContent = `${{filteredData.length}} lanes (showing ${{Math.min(filteredData.length, 500)}} of ${{savingsData.length}} total)`;
            
            if (filteredData.length === 0) {{
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 40px; color: #999;">
                            <div style="font-size: 48px; margin-bottom: 15px;">üîç</div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No lanes match your filters</div>
                            <div style="font-size: 13px;">Try adjusting your filter criteria or <a href="#" onclick="resetFilters(); return false;" style="color: #42B0D5;">reset all filters</a></div>
                        </td>
                    </tr>
                `;
            }}
        }}
        
        // =============================================================================
        // SELECTION
        // =============================================================================
        function toggleSelection(key, checked) {{
            if (checked) {{
                selectedItems.add(key);
            }} else {{
                selectedItems.delete(key);
            }}
            updatePlanStats();
            renderLanesTable();
            renderPlanItems();
        }}
        
        function toggleSelectAll() {{
            const checked = document.getElementById('selectAll').checked;
            filteredData.forEach(row => {{
                const key = `${{row.Week_Num}}-${{row['OD Pair']}}-${{row['Carrier Category']}}-${{row.CARRIER_NAME}}`;
                if (checked) {{
                    selectedItems.add(key);
                }} else {{
                    selectedItems.delete(key);
                }}
            }});
            updatePlanStats();
            renderLanesTable();
            renderPlanItems();
        }}
        
        function selectAllVisible() {{
            filteredData.forEach(row => {{
                const key = `${{row.Week_Num}}-${{row['OD Pair']}}-${{row['Carrier Category']}}-${{row.CARRIER_NAME}}`;
                selectedItems.add(key);
            }});
            updatePlanStats();
            renderLanesTable();
            renderPlanItems();
        }}
        
        function selectTopN(n) {{
            const sorted = [...savingsData].sort((a, b) => b.Potential_Savings - a.Potential_Savings);
            sorted.slice(0, n).forEach(row => {{
                const key = `${{row.Week_Num}}-${{row['OD Pair']}}-${{row['Carrier Category']}}-${{row.CARRIER_NAME}}`;
                selectedItems.add(key);
            }});
            updatePlanStats();
            renderLanesTable();
            renderPlanItems();
            showTab('plan');
        }}
        
        function selectByCategory(category) {{
            savingsData.filter(row => row['Carrier Category'] === category).forEach(row => {{
                const key = `${{row.Week_Num}}-${{row['OD Pair']}}-${{row['Carrier Category']}}-${{row.CARRIER_NAME}}`;
                selectedItems.add(key);
            }});
            updatePlanStats();
            renderLanesTable();
            renderPlanItems();
            showTab('plan');
        }}
        
        function selectHighCPM() {{
            savingsData.filter(row => row.CPM_Premium > 0.5).forEach(row => {{
                const key = `${{row.Week_Num}}-${{row['OD Pair']}}-${{row['Carrier Category']}}-${{row.CARRIER_NAME}}`;
                selectedItems.add(key);
            }});
            updatePlanStats();
            renderLanesTable();
            renderPlanItems();
            showTab('plan');
        }}
        
        function clearPlan() {{
            selectedItems.clear();
            updatePlanStats();
            renderLanesTable();
            renderPlanItems();
        }}
        
        function removeFromPlan(key) {{
            selectedItems.delete(key);
            updatePlanStats();
            renderLanesTable();
            renderPlanItems();
        }}
        
        // =============================================================================
        // PLAN STATS
        // =============================================================================
        function updatePlanStats() {{
            // Show filtered data stats (not just selected)
            const dataToShow = filteredData.length > 0 ? filteredData : savingsData;
            
            const lanes = new Set(dataToShow.map(r => r['OD Pair'])).size;
            const waybills = dataToShow.reduce((sum, r) => sum + r.Waybills, 0);
            const savings = dataToShow.reduce((sum, r) => sum + r.Potential_Savings, 0);
            const pct = totalSavings > 0 ? (savings / totalSavings * 100) : 0;
            
            document.getElementById('planLanes').textContent = lanes;
            document.getElementById('planWaybills').textContent = waybills.toLocaleString();
            document.getElementById('planSavings').textContent = '$' + savings.toLocaleString();
            document.getElementById('planPct').textContent = pct.toFixed(1) + '%';
        }}
        
        function updateKPIs() {{
            const totalFilteredSavings = filteredData.reduce((sum, r) => sum + r.Potential_Savings, 0);
            const totalFilteredSpend = filteredData.reduce((sum, r) => sum + (r.Total_Spend || 0), 0);
            const uniqueLanes = new Set(filteredData.map(r => r['OD Pair'])).size;
            const avgPremium = filteredData.length > 0 ? 
                filteredData.reduce((sum, r) => sum + r.CPM_Premium, 0) / filteredData.length : 0;
            const savingsPct = totalFilteredSpend > 0 ? (totalFilteredSavings / totalFilteredSpend) * 100 : 0;
            
            document.getElementById('kpiTotalSavings').textContent = '$' + (totalFilteredSavings/1000).toFixed(0) + 'K';
            document.getElementById('kpiLanes').textContent = uniqueLanes;
            document.getElementById('kpiAvgCPMPremium').textContent = '$' + avgPremium.toFixed(2);
            document.getElementById('kpiSavingsPct').textContent = savingsPct.toFixed(1) + '%';
            document.getElementById('headerSavings').textContent = '$' + (totalFilteredSavings/1000).toFixed(0) + 'K';
            
            // Update active filters display
            updateActiveFiltersDisplay();
        }}
        
        function updateActiveFiltersDisplay() {{
            const filters = [];
            const week = document.getElementById('filterWeek').value;
            const category = document.getElementById('filterCategory').value;
            const lane = document.getElementById('filterLane').value;
            const vendor = document.getElementById('filterVendor').value;
            const minSavings = document.getElementById('filterMinSavings').value;
            
            if (activeMonth !== 'all') filters.push('Month: ' + activeMonth.toUpperCase());
            if (week) filters.push('Week: ' + (weekLabels[week] || 'W' + week));
            if (category) filters.push('Category: ' + category);
            if (lane) filters.push('Lane: ' + lane);
            if (vendor) filters.push('Vendor: ' + vendor.substring(0, 20));
            if (minSavings) filters.push('Min Savings: $' + minSavings);
            
            const container = document.getElementById('activeFilters');
            const list = document.getElementById('activeFiltersList');
            
            if (filters.length > 0) {{
                container.style.display = 'block';
                list.innerHTML = filters.map(f => '<span style="background: white; padding: 3px 8px; margin-left: 8px; border-radius: 3px; color: #00243D;">' + f + '</span>').join('');
            }} else {{
                container.style.display = 'none';
            }}
        }}
        
        // =============================================================================
        // PLAN ITEMS
        // =============================================================================
        function renderPlanItems() {{
            const container = document.getElementById('planItems');
            const selectedData = savingsData.filter(row => {{
                const key = `${{row.Week_Num}}-${{row['OD Pair']}}-${{row['Carrier Category']}}-${{row.CARRIER_NAME}}`;
                return selectedItems.has(key);
            }});
            
            if (selectedData.length === 0) {{
                container.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 40px;">
                        No lanes selected yet. Go to Lane Analysis to select optimization opportunities.
                    </div>
                `;
                return;
            }}
            
            container.innerHTML = selectedData.map(row => {{
                const key = `${{row.Week_Num}}-${{row['OD Pair']}}-${{row['Carrier Category']}}-${{row.CARRIER_NAME}}`;
                return `
                    <div class="scenario-item">
                        <div class="scenario-info">
                            <div class="scenario-lane">${{row['OD Pair']}} (${{weekLabels[row.Week_Num]}})</div>
                            <div class="scenario-detail">
                                Switch from <strong>${{row.CARRIER_NAME}}</strong> (${{row.CPM.toFixed(2)}}/mi) 
                                ‚Üí <strong style="color: #28a745;">${{row.Best_Vendor}}</strong> (${{row.Best_CPM.toFixed(2)}}/mi)
                            </div>
                            <div class="scenario-detail">${{row['Carrier Category']}} | ${{row.Waybills}} waybills</div>
                        </div>
                        <div class="scenario-savings">$${{row.Potential_Savings.toLocaleString()}}</div>
                        <button class="scenario-remove" onclick="removeFromPlan('${{key}}')">&times;</button>
                    </div>
                `;
            }}).join('');
        }}
        
        // =============================================================================
        // CHARTS
        // =============================================================================
        function renderCategoryChart() {{
            // Use allData to get ALL categories, then filter for current view
            const catData = {{}};
            
            // Initialize all categories from full dataset
            categories.forEach(cat => catData[cat] = 0);
            
            // Sum savings from filtered data
            const dataToUse = filteredData.length > 0 ? filteredData : savingsData;
            dataToUse.forEach(row => {{
                const cat = row['Carrier Category'];
                if (cat) catData[cat] += row.Potential_Savings;
            }});
            
            const sorted = Object.entries(catData).sort((a, b) => b[1] - a[1]);
            const maxVal = sorted[0] ? sorted[0][1] : 1;
            
            document.getElementById('categoryChart').innerHTML = sorted.length > 0 ? sorted.map(([cat, val]) => `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-weight: 600; color: #00243D;">${{cat}}</span>
                        <span style="color: ${{val > 0 ? '#28a745' : '#999'}}; font-weight: 700;">${{val > 0 ? '$$' + val.toLocaleString() : 'No savings'}}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill ${{val > 0 ? 'success' : ''}}" style="width: ${{maxVal > 0 ? (val/maxVal*100) : 0}}%; ${{val === 0 ? 'background: #e9ecef;' : ''}}"></div>
                    </div>
                </div>
            `).join('') : '<div style="text-align: center; color: #999; padding: 20px;">No categories found</div>';
        }}
        
        function renderTopLanesChart() {{
            const dataToUse = filteredData.length > 0 ? filteredData : savingsData;
            const laneData = {{}};
            dataToUse.forEach(row => {{
                const lane = row['OD Pair'];
                if (!laneData[lane]) laneData[lane] = 0;
                laneData[lane] += row.Potential_Savings;
            }});
            
            const sorted = Object.entries(laneData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const maxVal = sorted[0] ? sorted[0][1] : 1;
            
            document.getElementById('topLanesChart').innerHTML = sorted.length > 0 ? sorted.map(([lane, val], i) => `
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <div style="width: 25px; height: 25px; background: #00243D; color: white; border-radius: 50%; 
                                display: flex; align-items: center; justify-content: center; font-size: 11px; margin-right: 10px;">
                        ${{i + 1}}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 12px;">${{lane}}</div>
                        <div class="progress-bar" style="height: 6px;">
                            <div class="progress-fill success" style="width: ${{(val/maxVal*100)}}%;"></div>
                        </div>
                    </div>
                    <div style="margin-left: 15px; font-weight: 700; color: #28a745;">$${{val.toLocaleString()}}</div>
                </div>
            `).join('') : '<div style="text-align: center; color: #999; padding: 20px;">No data matches current filters</div>';
        }}
        
        function renderVendorLists() {{
            const dataToUse = filteredData.length > 0 ? filteredData : savingsData;
            
            // Vendors to reduce
            const reduceData = {{}};
            dataToUse.forEach(row => {{
                const vendor = row.CARRIER_NAME;
                if (!vendor) return;
                if (!reduceData[vendor]) reduceData[vendor] = {{ savings: 0, waybills: 0 }};
                reduceData[vendor].savings += row.Potential_Savings;
                reduceData[vendor].waybills += row.Waybills;
            }});
            
            const reduceSorted = Object.entries(reduceData).sort((a, b) => b[1].savings - a[1].savings).slice(0, 10);
            
            document.getElementById('reduceVendorsList').innerHTML = reduceSorted.length > 0 ? reduceSorted.map(([vendor, data]) => `
                <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee;">
                    <div>
                        <div style="font-weight: 600;">${{vendor.substring(0, 35)}}</div>
                        <div style="font-size: 11px; color: #888;">${{data.waybills.toLocaleString()}} waybills</div>
                    </div>
                    <div style="background: #fde8e8; color: #dc3545; padding: 5px 12px; border-radius: 4px; font-weight: 600;">
                        $${{data.savings.toLocaleString()}}
                    </div>
                </div>
            `).join('') : '<div style="text-align: center; color: #999; padding: 20px;">No data matches current filters</div>';
            
            // Vendors to increase
            const increaseData = {{}};
            dataToUse.forEach(row => {{
                const vendor = row.Best_Vendor;
                if (!vendor) return;
                if (!increaseData[vendor]) increaseData[vendor] = {{ savings: 0, count: 0 }};
                increaseData[vendor].savings += row.Potential_Savings;
                increaseData[vendor].count += 1;
            }});
            
            const increaseSorted = Object.entries(increaseData).sort((a, b) => b[1].savings - a[1].savings).slice(0, 10);
            
            document.getElementById('increaseVendorsList').innerHTML = increaseSorted.length > 0 ? increaseSorted.map(([vendor, data]) => `
                <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee;">
                    <div>
                        <div style="font-weight: 600;">${{vendor.substring(0, 35)}}</div>
                        <div style="font-size: 11px; color: #888;">Best on ${{data.count}} lane combinations</div>
                    </div>
                    <div style="background: #e8f5e9; color: #28a745; padding: 5px 12px; border-radius: 4px; font-weight: 600;">
                        Preferred
                    </div>
                </div>
            `).join('') : '<div style="text-align: center; color: #999; padding: 20px;">No data matches current filters</div>';
        }}
        
        function renderWeeklyTrend() {{
            const dataToUse = filteredData.length > 0 ? filteredData : savingsData;
            const weeklyData = {{}};
            weeks.forEach(w => weeklyData[w] = 0);
            dataToUse.forEach(row => {{
                weeklyData[row.Week_Num] += row.Potential_Savings;
            }});
            
            const maxVal = Math.max(...Object.values(weeklyData));
            
            document.getElementById('weeklyTrendChart').innerHTML = `
                <div style="display: flex; align-items: flex-end; height: 250px; gap: 8px; padding: 20px;">
                    ${{weeks.map(w => {{
                        const month = weekToMonth[w];
                        const color = month === 'oct' ? '#ff6b35' : month === 'nov' ? '#f7931e' : '#00a651';
                        return `
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                                <div style="color: #28a745; font-weight: 700; margin-bottom: 5px; font-size: 10px;">$${{(weeklyData[w]/1000).toFixed(0)}}K</div>
                                <div style="width: 100%; background: ${{color}}; border-radius: 4px 4px 0 0; 
                                            height: ${{maxVal > 0 ? (weeklyData[w]/maxVal*180) : 0}}px;"></div>
                                <div style="margin-top: 10px; font-size: 10px; color: #666; writing-mode: vertical-rl; text-orientation: mixed;">${{weekLabels[w]}}</div>
                            </div>
                        `;
                    }}).join('')}}
                </div>
                <div style="display: flex; justify-content: center; gap: 20px; margin-top: 10px;">
                    <div style="display: flex; align-items: center; gap: 5px;"><div style="width: 12px; height: 12px; background: #ff6b35; border-radius: 2px;"></div> October</div>
                    <div style="display: flex; align-items: center; gap: 5px;"><div style="width: 12px; height: 12px; background: #f7931e; border-radius: 2px;"></div> November</div>
                    <div style="display: flex; align-items: center; gap: 5px;"><div style="width: 12px; height: 12px; background: #00a651; border-radius: 2px;"></div> December</div>
                </div>
            `;
        }}
        
        function renderWeeklyCategoryTable() {{
            const dataToUse = filteredData.length > 0 ? filteredData : savingsData;
            const data = {{}};
            
            // Initialize ALL categories from the full dataset
            categories.forEach(cat => {{
                data[cat] = {{}};
                weeks.forEach(w => data[cat][w] = 0);
                data[cat].total = 0;
            }});
            
            dataToUse.forEach(row => {{
                const cat = row['Carrier Category'];
                const week = row.Week_Num;
                if (data[cat]) {{
                    data[cat][week] += row.Potential_Savings;
                    data[cat].total += row.Potential_Savings;
                }}
            }});
            
            const sorted = Object.entries(data).sort((a, b) => b[1].total - a[1].total);
            
            document.getElementById('weeklyCategoryBody').innerHTML = sorted.map(([cat, weekData]) => `
                <tr>
                    <td style="position: sticky; left: 0; background: white; z-index: 1;"><strong>${{cat}}</strong></td>
                    ${{weeks.map(w => `<td class="number">$${{weekData[w].toLocaleString()}}</td>`).join('')}}
                    <td class="number" style="background: #e8f5e9; font-weight: 600; color: #28a745;">$${{weekData.total.toLocaleString()}}</td>
                </tr>
            `).join('');
        }}
        
        function renderMonthlyCharts() {{
            const dataToUse = filteredData.length > 0 ? filteredData : savingsData;
            const monthlyData = {{ oct: {{ savings: 0, waybills: 0, lanes: new Set() }}, 
                                   nov: {{ savings: 0, waybills: 0, lanes: new Set() }}, 
                                   dec: {{ savings: 0, waybills: 0, lanes: new Set() }} }};
            
            dataToUse.forEach(row => {{
                const month = weekToMonth[row.Week_Num];
                if (month && monthlyData[month]) {{
                    monthlyData[month].savings += row.Potential_Savings;
                    monthlyData[month].waybills += row.Waybills;
                    monthlyData[month].lanes.add(row['OD Pair']);
                }}
            }});
            
            const maxSavings = Math.max(monthlyData.oct.savings, monthlyData.nov.savings, monthlyData.dec.savings);
            
            document.getElementById('monthlyChart').innerHTML = `
                <div style="display: flex; align-items: flex-end; height: 250px; gap: 40px; padding: 20px; justify-content: center;">
                    <div style="display: flex; flex-direction: column; align-items: center; width: 150px;">
                        <div style="color: #28a745; font-weight: 700; margin-bottom: 10px; font-size: 18px;">$${{(monthlyData.oct.savings/1000).toFixed(0)}}K</div>
                        <div style="width: 100%; background: #ff6b35; border-radius: 8px 8px 0 0; 
                                    height: ${{maxSavings > 0 ? (monthlyData.oct.savings/maxSavings*180) : 0}}px;"></div>
                        <div style="margin-top: 15px; font-weight: 600;">October</div>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: center; width: 150px;">
                        <div style="color: #28a745; font-weight: 700; margin-bottom: 10px; font-size: 18px;">$${{(monthlyData.nov.savings/1000).toFixed(0)}}K</div>
                        <div style="width: 100%; background: #f7931e; border-radius: 8px 8px 0 0; 
                                    height: ${{maxSavings > 0 ? (monthlyData.nov.savings/maxSavings*180) : 0}}px;"></div>
                        <div style="margin-top: 15px; font-weight: 600;">November</div>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: center; width: 150px;">
                        <div style="color: #28a745; font-weight: 700; margin-bottom: 10px; font-size: 18px;">$${{(monthlyData.dec.savings/1000).toFixed(0)}}K</div>
                        <div style="width: 100%; background: #00a651; border-radius: 8px 8px 0 0; 
                                    height: ${{maxSavings > 0 ? (monthlyData.dec.savings/maxSavings*180) : 0}}px;"></div>
                        <div style="margin-top: 15px; font-weight: 600;">December</div>
                    </div>
                </div>
            `;
            
            // Monthly summaries
            ['oct', 'nov', 'dec'].forEach(month => {{
                const data = monthlyData[month];
                const monthName = month === 'oct' ? 'October' : month === 'nov' ? 'November' : 'December';
                document.getElementById(`${{month}}Summary`).innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 28px; font-weight: 700; color: #28a745;">$${{data.savings.toLocaleString()}}</div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 15px;">Potential Savings</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center;">
                            <div>
                                <div style="font-size: 20px; font-weight: 600; color: #00243D;">${{data.lanes.size}}</div>
                                <div style="font-size: 11px; color: #888;">Lanes</div>
                            </div>
                            <div>
                                <div style="font-size: 20px; font-weight: 600; color: #00243D;">${{data.waybills.toLocaleString()}}</div>
                                <div style="font-size: 11px; color: #888;">Waybills</div>
                            </div>
                        </div>
                    </div>
                `;
            }});
        }}
        
        // =============================================================================
        // VENDOR COMPARISON
        // =============================================================================
        function populateLaneDropdown() {{
            const lanes = [...new Set(savingsData.map(r => r['OD Pair']))].sort();
            document.getElementById('compareLane').innerHTML = `
                <option value="">Select a lane...</option>
                ${{lanes.map(l => `<option value="${{l}}">${{l}}</option>`).join('')}}
            `;
        }}
        
        function updateVendorComparison() {{
            const lane = document.getElementById('compareLane').value;
            if (!lane) {{
                document.getElementById('vendorComparison').innerHTML = '';
                return;
            }}
            
            const laneData = allData.filter(r => r['OD Pair'] === lane);
            if (laneData.length < 2) {{
                document.getElementById('vendorComparison').innerHTML = '<p>Not enough vendors to compare on this lane.</p>';
                return;
            }}
            
            const sorted = laneData.sort((a, b) => a.CPM - b.CPM);
            const best = sorted[0];
            const worst = sorted[sorted.length - 1];
            const savings = (worst.CPM - best.CPM) * worst.Total_Miles;
            
            document.getElementById('vendorComparison').innerHTML = `
                <div class="vendor-compare">
                    <div class="vendor-box current">
                        <div style="font-size: 10px; color: #dc3545; text-transform: uppercase; margin-bottom: 10px;">Higher Cost</div>
                        <div class="vendor-name">${{worst.CARRIER_NAME}}</div>
                        <div class="vendor-cpm high">$${{worst.CPM.toFixed(2)}}/mi</div>
                        <div style="margin-top: 10px; font-size: 12px; color: #666;">
                            ${{worst.Waybills}} waybills | ${{worst.Total_Miles.toLocaleString()}} miles
                        </div>
                    </div>
                    <div class="vs-circle">VS</div>
                    <div class="vendor-box recommended">
                        <div style="font-size: 10px; color: #28a745; text-transform: uppercase; margin-bottom: 10px;">Recommended</div>
                        <div class="vendor-name">${{best.CARRIER_NAME}}</div>
                        <div class="vendor-cpm low">$${{best.CPM.toFixed(2)}}/mi</div>
                        <div style="margin-top: 10px; font-size: 12px; color: #666;">
                            ${{best.Waybills}} waybills | ${{best.Total_Miles.toLocaleString()}} miles
                        </div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 30px; padding: 20px; background: #e8f5e9; border-radius: 8px;">
                    <div style="font-size: 14px; color: #666;">Potential Savings on This Lane</div>
                    <div style="font-size: 36px; font-weight: 700; color: #28a745;">$${{savings.toLocaleString()}}</div>
                    <div style="font-size: 12px; color: #888;">CPM Difference: $${{(worst.CPM - best.CPM).toFixed(2)}}/mile</div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4 style="margin-bottom: 15px; color: #00243D;">All Vendors on This Lane</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Vendor</th>
                                <th>Category</th>
                                <th>Week</th>
                                <th class="number">CPM</th>
                                <th class="number">Waybills</th>
                                <th class="number">Spend</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${{sorted.map((r, i) => `
                                <tr style="${{i === 0 ? 'background: #e8f5e9;' : ''}}">
                                    <td>${{i + 1}}</td>
                                    <td>${{i === 0 ? '‚≠ê ' : ''}}${{r.CARRIER_NAME}}</td>
                                    <td>${{r['Carrier Category']}}</td>
                                    <td>${{weekLabels[r.Week_Num]}}</td>
                                    <td class="number ${{i === 0 ? 'savings' : ''}}">$${{r.CPM.toFixed(2)}}</td>
                                    <td class="number">${{r.Waybills}}</td>
                                    <td class="number">$${{r.Total_Spend.toLocaleString()}}</td>
                                </tr>
                            `).join('')}}
                        </tbody>
                    </table>
                </div>
            `;
        }}
        
        // =============================================================================
        // EXPORT
        // =============================================================================
        function exportPlanCSV() {{
            const selectedData = savingsData.filter(row => {{
                const key = `${{row.Week_Num}}-${{row['OD Pair']}}-${{row['Carrier Category']}}-${{row.CARRIER_NAME}}`;
                return selectedItems.has(key);
            }});
            
            if (selectedData.length === 0) {{
                alert('No items selected. Please select lanes to export.');
                return;
            }}
            
            const headers = ['Week', 'Month', 'Lane', 'Category', 'Current Vendor', 'Current CPM', 'Best Vendor', 'Best CPM', 'Waybills', 'Potential Savings'];
            const rows = selectedData.map(r => [
                weekLabels[r.Week_Num],
                weekToMonth[r.Week_Num].toUpperCase(),
                r['OD Pair'],
                r['Carrier Category'],
                r.CARRIER_NAME,
                r.CPM,
                r.Best_Vendor,
                r.Best_CPM,
                r.Waybills,
                r.Potential_Savings
            ]);
            
            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\\n');
            const blob = new Blob([csv], {{ type: 'text/csv' }});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'MLH_Q4_2025_Optimization_Plan.csv';
            a.click();
        }}
        
        function exportPlanPDF() {{
            alert('PDF export would generate a formatted report. For now, use browser Print (Ctrl+P) and save as PDF.');
            window.print();
        }}
        
        function generateActionReport() {{
            const selectedData = savingsData.filter(row => {{
                const key = `${{row.Week_Num}}-${{row['OD Pair']}}-${{row['Carrier Category']}}-${{row.CARRIER_NAME}}`;
                return selectedItems.has(key);
            }});
            
            const totalSelectedSavings = selectedData.reduce((sum, r) => sum + r.Potential_Savings, 0);
            const lanes = new Set(selectedData.map(r => r['OD Pair'])).size;
            
            const report = `
MLH CARRIER OPTIMIZATION ACTION REPORT - Q4 2025
Generated: ${{new Date().toLocaleDateString()}}
================================================

SUMMARY
-------
Selected Lanes: ${{lanes}}
Total Waybills: ${{selectedData.reduce((sum, r) => sum + r.Waybills, 0).toLocaleString()}}
Projected Savings: $${{totalSelectedSavings.toLocaleString()}}

DETAILED ACTIONS
----------------
${{selectedData.map(r => `
- Lane: ${{r['OD Pair']}} (${{weekLabels[r.Week_Num]}})
  Category: ${{r['Carrier Category']}}
  Current: ${{r.CARRIER_NAME}} @ $${{r.CPM.toFixed(2)}}/mi
  Switch to: ${{r.Best_Vendor}} @ $${{r.Best_CPM.toFixed(2)}}/mi
  Savings: $${{r.Potential_Savings.toLocaleString()}}
`).join('')}}
            `;
            
            const blob = new Blob([report], {{ type: 'text/plain' }});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'MLH_Q4_2025_Action_Report.txt';
            a.click();
        }}
    </script>

</body>
</html>
"""

# =============================================================================
# SAVE AND DISPLAY
# =============================================================================

output_path = "/lakehouse/default/Files/MLH_Q4_2025_Interactive_Planning_Tool.html"
with open(output_path, "w", encoding="utf-8") as f:
    f.write(interactive_dashboard)

b64 = base64.b64encode(interactive_dashboard.encode()).decode()

download_html = f"""
<div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, {MAERSK_NAVY} 0%, {MAERSK_TEAL} 100%); border-radius: 8px; font-family: Arial; color: white;">
    <h3 style="margin: 0 0 15px 0; font-size: 18px;">üöÄ MLH Q4 2025 Interactive Planning Tool</h3>
    <p style="margin: 0 0 15px 0; opacity: 0.9; font-size: 13px;">
        October - December 2025 | {len(weeks)} Weeks | Explore data, compare vendors, build optimization plans
    </p>
    
    <a href="data:text/html;base64,{b64}" download="MLH_Q4_2025_Interactive_Planning_Tool.html" 
       style="display: inline-block; background: white; color: {MAERSK_NAVY}; padding: 12px 24px; 
              text-decoration: none; border-radius: 4px; font-size: 14px; font-weight: 600;">
       üì• Download Interactive Tool
    </a>
    
    <p style="margin: 15px 0 0 0; font-size: 11px; opacity: 0.7;">
        Open the downloaded HTML file in any browser for full interactivity
    </p>
</div>
"""

print("=" * 60)
print("MLH Q4 2025 INTERACTIVE PLANNING TOOL GENERATED")
print("=" * 60)
print(f"Period: October - December 2025")
print(f"Weeks: {weeks} ({len(weeks)} weeks)")
print(f"Total Records: {len(all_data):,}")
print(f"Savings Opportunities: {len(savings_data):,}")
print(f"Total Potential Savings: ${total_savings_q4:,.0f}")
print(f"Categories: {len(categories)}")
print("=" * 60)

display(HTML(download_html))
display(HTML(interactive_dashboard))
